@model IEnumerable<ProductReviewViewModel>

@using System.Globalization
@using ES.Web.Areas.EsAdmin.Models
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

@{
    ViewData["Title"] = @Localizer["Product Reviews"];
    int totalCount = ViewBag.TotalCount ?? 0;
    int page = ViewBag.Page ?? 1;
    int pageSize = ViewBag.PageSize ?? 6;
    int totalPages = (int)Math.Ceiling((double)totalCount / pageSize);
    int productId = ViewBag.ProductId;
    string search = ViewBag.Search ?? "";
    string sort = ViewBag.Sort ?? "";
    bool showPublished = ViewBag.ShowPublished ?? true;

    var baseUrl = $"{Context.Request.Scheme}://{Context.Request.Host}{Context.Request.PathBase}";
}

@section Styles {
    <style>
        .card {
            transition: transform 0.2s;
        }

            .card:hover {
                transform: translateY(-5px);
            }

        .list-group-item {
            border: none;
            padding: 0.5rem 0;
        }

        .collapse-md {
            display: block;
        }

        @@media (max-width: 768px) {
            .row-cols-md-2 > .col {
                flex: 0 0 100%;
                max-width: 100%;
            }

            .collapse-md {
                display: none;
            }

                .collapse-md.show {
                    display: block;
                }
        }
    </style>

}

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="text-dark fw-bold">
                @if (Model.Any())
                {
                    @Localizer["Reviews for", Model.First().ProductName]
                }
                else
                {
                    @Localizer["Product Reviews"]
                }
            </h2>
            <div class="mt-2">
                @if (Model.Any())
                {
                    <p class="text-success fw-semibold fs-5">@Localizer["Reviews Count", totalCount]</p>
                }
                <a href="@Url.Action("Index", "Products")" class="btn btn-outline-secondary">
                    <i class="lni lni-arrow-left me-2"></i>@Localizer["back to products"]
                </a>
            </div>


            <form method="get" asp-action="ViewReviews" asp-route-productId="@productId" class="row g-3 mt-2">
                <!-- Hidden inputs to preserve all parameters -->
                <input type="hidden" name="productId" value="@productId" />
                <input type="hidden" name="page" value="@ViewBag.Page" />
                <input type="hidden" name="pageSize" value="@ViewBag.PageSize" />
                <!-- Visible inputs -->
                <div class="col-md-6 col-12">
                    <div class="input-group">
                        <span class="input-group-text"><i class="lni lni-search"></i></span>
                        <input type="text" name="search" class="form-control" placeholder="@Localizer["SearchPlaceholder"]" value="@ViewBag.Search">
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <select name="sort" class="form-select" onchange="this.form.submit()">
                        <option value="" selected="@(ViewBag.Sort == null || ViewBag.Sort == "" ? "selected" : null)">@Localizer["SortBy"]</option>
                        <option value="date-desc" selected="@(ViewBag.Sort == "date-desc" ? "selected" : null)">@Localizer["NewestFirst"]</option>
                        <option value="date-asc" selected="@(ViewBag.Sort == "date-asc" ? "selected" : null)">@Localizer["OldestFirst"]</option>
                    </select>
                </div>

                <div class="col-md-3 col-6">
                    <button type="submit" class="btn btn-primary w-100"><i class="lni lni-funnel me-2"></i>@Localizer["Filter"]</button>
                </div>
                <div class="col-12 mt-3">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="showPublished" name="showPublished" value="true" @(ViewBag.showPublished ? "checked" : "") onchange="this.form.submit()">
                        <label class="form-check-label" for="showPublished">@Localizer["showPublished"]</label>
                    </div>
                </div>
            </form>
        </div>
    </div>

    @if (Model.Any())
    {
        <!-- Bulk Actions -->
        <form method="post" asp-action="BulkAction" asp-route-productId="@productId" class="mb-4">
            <div class="btn-group" role="group">
                <button type="submit" class="btn btn-success" name="action" value="toggle-publish">
                    <i class="lni lni-checkmark me-2"></i>@Localizer["TogglePublishing"]
                </button>
            </div>

            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mt-3">
                @foreach (var rev in Model)
                {
                    <div class="col">
                        <div class="card h-100 shadow-sm position-relative">
                            <input type="checkbox" name="selectedIds" value="@rev.ReviewId" class="position-absolute top-0 start-0 m-2">
                            <div class="card-header bg-info text-white">
                                <h5 class="card-title mb-0 d-flex align-items-center">
                                    @Localizer["Review number", rev.ReviewId]
                                    @if (rev.IsPublished)
                                    {
                                        <span class="badge bg-success"><i class="lni lni-checkmark me-1"></i>@Localizer["Published"]</span>
                                    }
                                </h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">
                                    <i class="lni lni-alarm-clock me-2"></i>@Localizer["SubmittedAt", rev.SubmittedAt.ToString("MMMM dd, yyyy HH:mm")]
                                </p>
                                <h6 class="fw-bold">@Localizer["Details"]</h6>
                                <ul class="list-group list-group-flush collapse-md">
                                    @foreach (var detail in rev.Details)
                                    {
                                        <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                                            <span class="fw-medium me-2">
                                                <i class="@(detail.FieldType == "email" ? "lni lni-envelope" : detail.FieldType == "phoneNumber" ? "lni lni-phone" : "lni lni-text-align-left") me-1"></i>@detail.FieldName
                                            </span>
                                            <span class="text-muted">
                                                @switch (detail.FieldType)
                                                {
                                                    case "text":
                                                    case "textarea":
                                                    case "phoneNumber":
                                                    case "email":
                                                        @if (string.IsNullOrEmpty(detail.ResponseValue))
                                                        {
                                                            @Localizer["NoResponse"]
                                                        }
                                                        else
                                                        {
                                                            @detail.ResponseValue
                                                        }
                                                        break;
                                                    case "select":
                                                    case "rating":
                                                        @if (string.IsNullOrEmpty(detail.ResponseValue))
                                                        {
                                                            @Localizer["NoResponse"]
                                                        }
                                                        else
                                                        {
                                                            @detail.ResponseValue
                                                        }
                                                        break;
                                                    case "checkbox":
                                                        @if (string.IsNullOrEmpty(detail.ResponseValue))
                                                        {
                                                            @Localizer["NotSelected"]
                                                        }
                                                        else
                                                        {
                                                            @detail.ResponseValue
                                                        }
                                                        break;
                                                    case "file":
                                                        if (!string.IsNullOrEmpty(detail.FileUrl))
                                                        {
                                                            var url = baseUrl + detail.FileUrl;
                                                            string extension = "";
                                                            if (!string.IsNullOrEmpty(detail.ResponseValue) && detail.ResponseValue.Contains("."))
                                                            {
                                                                extension = detail.ResponseValue.Substring(detail.ResponseValue.LastIndexOf(".")).ToLower();
                                                            }
                                                            if (extension == ".jpg" || extension == ".jpeg" || extension == ".png")
                                                            {
                                                                <a href="@url" target="_blank" class="btn btn-sm btn-outline-primary">@Localizer["ViewImage"]</a>
                                                            }
                                                            else if (extension == ".pdf")
                                                            {
                                                                <a href="@url" target="_blank" class="btn btn-sm btn-outline-primary">@Localizer["ViewPDF"]</a>
                                                            }
                                                            else if (extension == ".doc" || extension == ".docx")
                                                            {
                                                                <a href="@url" target="_blank" class="btn btn-sm btn-outline-primary">@Localizer["DownloadWord"]</a>
                                                            }
                                                            else
                                                            {
                                                                <a href="@url" target="_blank" class="btn btn-sm btn-outline-primary">@Localizer["DownloadFile"]</a>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            @Localizer["NoFileUploaded"]
                                                        }
                                                        break;
                                                    case "date":
                                                        {
                                                            if (DateTime.TryParse(detail.ResponseValue, out DateTime dateValue))
                                                            {
                                                                @dateValue.ToString("MMMM dd, yyyy")
                                                            }
                                                            else if (string.IsNullOrEmpty(detail.ResponseValue))
                                                            {
                                                                @Localizer["InvalidDate"]
                                                            }
                                                            else
                                                            {
                                                                @detail.ResponseValue
                                                            }
                                                        }
                                                        break;
                                                    default:
                                                        @if (string.IsNullOrEmpty(detail.ResponseValue))
                                                        {
                                                            @Localizer["NoResponse"]
                                                        }
                                                        else
                                                        {
                                                            @detail.ResponseValue
                                                        }
                                                        break;
                                                }
                                            </span>
                                        </li>
                                    }
                                </ul>
                            </div>
                            <!-- Toggle Details Button for Mobile -->
                            <div class="card-footer text-center d-md-none">
                                <button class="btn btn-sm btn-outline-secondary toggle-details" data-target="collapse-md-@rev.ReviewId">@Localizer["ToggleDetails"]</button>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <nav aria-label="@Localizer["PaginationLabel"]" class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item @(page <= 1 ? "disabled" : "")">
                        <a class="page-link" href="@Url.Action("ViewReviews", new { productId, page = page - 1, pageSize, search, sort, showPublished })" aria-label="@Localizer["Previous"]">
                            <span aria-hidden="true">«</span>
                        </a>
                    </li>
                    @for (int i = 1; i <= totalPages; i++)
                    {
                        <li class="page-item @(i == page ? "active" : "")">
                            <a class="page-link" href="@Url.Action("ViewReviews", new {productId, page = i, pageSize, search, sort,showPublished})">@i</a>
                        </li>
                    }
                    <li class="page-item @(page >= totalPages ? "disabled" : "")">
                        <a class="page-link" href="@Url.Action("ViewReviews", new { productId, page = page + 1, pageSize, search, sort, showPublished })" aria-label="@Localizer["Next"]">
                            <span aria-hidden="true">»</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </form>
    }
    else
    {
        <div class="alert alert-info text-center" role="alert">
            <i class="lni lni-information me-2"></i>@Localizer["No reviews Found"]
        </div>
    }
</div>

@section Scripts {
    <script>
        document.querySelectorAll('.toggle-details').forEach(button => {
            button.addEventListener('click', function () {
                const target = document.querySelector(`.${this.dataset.target}`);
                target.classList.toggle('show');
            });
        });
    </script>
}