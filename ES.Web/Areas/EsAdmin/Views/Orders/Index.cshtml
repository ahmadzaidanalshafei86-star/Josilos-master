@model IEnumerable<OrderViewModel>

@using System.Globalization
@using ES.Web.Areas.EsAdmin.Models
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["Orders"];
    var currentCulture = CultureInfo.CurrentCulture.Name; // e.g., "en-US" or "ar-JO"
}

@section Styles {
    <link rel="stylesheet" href="~/CMS/css/orders.css">
}

<!-- Modern UI with Fobia Template -->
<div class="container-fluid py-4">
    <h2 class="mb-4 d-flex align-items-center">
        <i class="lni lni-cart me-2"></i> @Localizer["Orders"]
    </h2>


    <!-- Search, Sort, and Filter Controls -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">@Localizer["SearchByMobile"]</label>
                    <input type="text" id="searchMobile" class="form-control" placeholder="@Localizer["EnterMobile"]">
                </div>
                <div class="col-md-3">
                    <label class="form-label">@Localizer["SortByDate"]</label>
                    <select id="sortDate" class="form-select">
                        <option value="newest">@Localizer["NewestFirst"]</option>
                        <option value="oldest">@Localizer["OldestFirst"]</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <select id="filterStatus" class="form-select">
                        <option value="pending">@Localizer["PendingOrders"]</option>
                        <option value="all">@Localizer["AllOrders"]</option>
                        <option value="completed">@Localizer["CompletedOrders"]</option>
                        <option value="canceled">@Localizer["CanceledOrders"]</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button id="applyFilters" class="btn btn-info w-100">
                        <i class="lni lni-funnel"></i> @Localizer["ApplyFilters"]
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- Orders List -->
    <div id="ordersContainer" class="row">
        @foreach (var order in Model)
        {
            <div class="col-md-4 mb-4 order-card" data-mobile="@order.MobilePhone" data-date="@order.CreatedAt.ToString("yyyy-MM-ddTHH:mm:ss")">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">@Localizer["Order"] #@order.Id</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">@Localizer["Customer"]</dt>
                            <dd class="col-sm-8">@order.CustomerFullName</dd>

                            <dt class="col-sm-4">@Localizer["Phone"]</dt>
                            <dd class="col-sm-8">@order.MobilePhone</dd>

                            <dt class="col-sm-4">@Localizer["Email"]</dt>
                            <dd class="col-sm-8">@order.Email</dd>

                            <dt class="col-sm-4">@Localizer["Address"]</dt>
                            <dd class="col-sm-8">@order.StreetAddress</dd>

                            <dt class="col-sm-4">@Localizer["City"]</dt>
                            <dd class="col-sm-8">@order.City</dd>

                            <dt class="col-sm-4">@Localizer["Country"]</dt>
                            <dd class="col-sm-8">@order.Country</dd>

                            <dt class="col-sm-4">@Localizer["Payment"]</dt>
                            <dd class="col-sm-8">@order.PaymentMethod</dd>

                            <dt class="col-sm-4">@Localizer["Subtotal"]</dt>
                            <dd class="col-sm-8">@order.Subtotal.ToString("C")</dd>

                            <dt class="col-sm-4">@Localizer["Shipping"]</dt>
                            <dd class="col-sm-8">@order.ShippingCost.ToString("C")</dd>

                            <dt class="col-sm-4">@Localizer["Total"]</dt>
                            <dd class="col-sm-8">@order.EstimatedTotal.ToString("C")</dd>

                            @if (!string.IsNullOrWhiteSpace(order.OrderComment))
                            {
                                <dt class="col-sm-4">@Localizer["Comment"]</dt>
                                <dd class="col-sm-8">@order.OrderComment</dd>
                            }

                            <dt class="col-sm-4">@Localizer["CreatedAt"]</dt>
                            <dd class="col-sm-8">@order.CreatedAt.ToString("g")</dd>

                            <dt class="col-sm-4">@Localizer["Status"]</dt>
                            <dd class="col-sm-8">
                                <span class="badge @(order.IsDelivered ? "bg-success" : order.IsCancelled ? "bg-danger" : "bg-warning")">
                                    @(order.IsDelivered ? Localizer["Completed"] : order.IsCancelled ? Localizer["Cancelled"] : Localizer["Pending"])
                                </span>
                            </dd>
                        </dl>

                        <h6 class="mt-3">@Localizer["Items"]</h6>
                        <ul class="list-group list-group-flush mb-3">
                            @foreach (var item in order.Items)
                            {
                                <li class="list-group-item">
                                    <strong>@item.ProductTitle@(!string.IsNullOrEmpty(item.CustomizationName)  ? $" ({item.CustomizationName})" : "")</strong> X (@item.Quantity)
                                    @if (item.SelectedAttributes.Any())
                                    {
                                        <div class="text-muted small">@Localizer["Included"]: @string.Join(", ", item.SelectedAttributes.Select(a => a.Value))</div>
                                    }
                                </li>
                            }
                        </ul>
                        @if (!order.IsDelivered && !order.IsCancelled)
                        {
                            <button class="btn btn-success w-100 mb-2 d-flex align-items-center justify-content-center complete-order" data-order-id="@order.Id">
                                <i class="lni lni-checkmark-circle me-2"></i> @Localizer["MarkAsCompleted"]
                            </button>

                            <button class="btn btn-danger w-100 d-flex align-items-center justify-content-center cancel-order" data-order-id="@order.Id">
                                <i class="lni lni-close me-2"></i> @Localizer["MarkAsCancel"]
                            </button>

                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script>
        // Pass current culture to JavaScript
        window.currentCulture = '@currentCulture';
    </script>
    <script src="~/CMS/js/orders.js"></script>
}